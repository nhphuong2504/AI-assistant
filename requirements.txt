pandas
numpy
python-dateutil

# Web
fastapi
uvicorn

# UI
streamlit

# Visualization
plotly

openai
python-dotenv
lifetimes
scipy
lifelines

# Analytics function definitions with fixed parameters
ANALYTICS_FUNCTIONS = [
    {
        "type": "function",
        "function": {
            "name": "predict_customer_lifetime_value",
            "description": "Predict Customer Lifetime Value (CLV) using BG/NBD and Gamma-Gamma models. Use this for questions about: customer lifetime value, CLV, future customer value, predicted revenue per customer, customer worth, or which customers are most valuable. Calibration cutoff date is fixed at 2011-12-09.",
            "parameters": {
                "type": "object",
                "properties": {
                    "horizon_days": {
                        "type": "integer",
                        "description": "Prediction horizon in days (default: 90)",
                        "minimum": 1,
                        "maximum": 365,
                        "default": 90
                    },
                    "limit_customers": {
                        "type": "integer",
                        "description": "Maximum number of customers to return (default: 10)",
                        "minimum": 1,
                        "maximum": 5000,
                        "default": 10
                    }
                },
                "required": [horizon_days]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "score_churn_risk",
            "description": "Score customers by churn risk using survival analysis (Cox model). Use this for questions about: churn risk, customer retention risk, which customers are likely to churn, risk scoring, or high-risk customers. Cutoff date is fixed at 2011-12-09, inactivity days is fixed at 90.",
            "parameters": {
                "type": "object",
                "properties": {},
                "required": []
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "predict_churn_probability",
            "description": "Predict the probability that active customers will churn in the next X days. Use this for questions about: churn probability, likelihood of leaving, retention probability, or probability of churn. Cutoff date is fixed at 2011-12-09, inactivity days is fixed at 90.",
            "parameters": {
                "type": "object",
                "properties": {
                    "X_days": {
                        "type": "integer",
                        "description": "Prediction horizon in days (default: 90)",
                        "minimum": 1,
                        "maximum": 365,
                        "default": 90
                    }
                },
                "required": [X_days]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "customer_segmentation",
            "description": "Build customer segmentation combining risk labels and expected remaining lifetime. Use this for questions about: customer segments, segmentation, customer groups, risk-based segments, or action recommendations for customers. Cutoff date is fixed at 2011-12-09, inactivity days is fixed at 90.",
            "parameters": {
                "type": "object",
                "properties": {
                    "H_days": {
                        "type": "integer",
                        "description": "Horizon in days for expected remaining lifetime (default: 365)",
                        "minimum": 1,
                        "maximum": 3650,
                        "default": 365
                    }
                },
                "required": []
            }
        }
    }
]

# SQL function definition
SQL_FUNCTION = {
    "type": "function",
    "function": {
        "name": "execute_sql_query",
        "description": "Execute a SQL SELECT query to answer questions about historical data, aggregations, filtering, reporting, or data exploration. Use this for descriptive questions that don't require predictive modeling, such as: revenue by country, top customers, sales trends, product analysis, or any data aggregation/filtering questions.",
        "parameters": {
            "type": "object",
            "properties": {
                "sql": {
                    "type": "string",
                    "description": "A valid SQL SELECT query (may start with WITH for CTEs, no semicolons). Must only query the transactions table. Always use LIMIT 500 unless aggregation already produces small output."
                },
                "explanation": {
                    "type": "string",
                    "description": "Brief explanation of what the query does and what it answers"
                }
            },
            "required": ["sql", "explanation"]
        }
    }
}

# Combine all functions
ALL_FUNCTIONS = ANALYTICS_FUNCTIONS + [SQL_FUNCTION]

# Updated system prompt for routing
SYSTEM_ROUTER = """You are a data assistant for an Online Retail SQLite database.
You can answer questions using either SQL queries or specialized analytics functions.

Available tools:
1. execute_sql_query - for descriptive questions, aggregations, filtering, reporting, data exploration
2. Analytics functions - for predictive modeling, CLV prediction, churn analysis, survival analysis

When to use execute_sql_query:
- Questions about historical data, aggregations, counts, sums, averages
- Filtering, grouping, sorting data
- Reporting on what happened
- Simple data exploration
- Revenue by country/month/product
- Top customers/products
- Sales trends

When to use analytics functions:
- Questions about predictions, future values, probabilities
- Customer lifetime value, CLV, future revenue
- Churn risk, retention risk, churn probability
- Survival analysis, retention curves
- Customer segmentation based on risk/lifetime

Always choose the most appropriate tool. If the question can be answered with SQL, use execute_sql_query. If it requires predictive modeling or advanced analytics, use the appropriate analytics function.
"""